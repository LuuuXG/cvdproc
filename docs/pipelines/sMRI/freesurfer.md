# Freesurfer pipeline

::: cvdproc.pipelines.smri.freesurfer_pipeline

----

## A more detailed description:

### Freesurfer: Principle Methodological Considerations

#### Freesurfer Version

The current pipeline uses the Freesurfer 7-dev version (freesurfer-linux-ubuntu22_x86_64-dev-20240909-9ca95c6). Although we prefer using deep learning-based tools implemented in Freesurfer 8 for more accurate and robust processing, the 8 version requires a larger RAM. For our groups with limited computational resources, we opt for the 7-dev version and parallelize the processing of multiple subjects to optimize resource usage.

#### External Brain Mask

We found that the default brainmask generated by Freesurfer may not be optimal for all datasets. Therefore, we choose to use an external brain mask with `mri_synthstrip` to replace the brain extraction step. Notably, we take the `--no-csf` option in `mri_synthstrip` to avoid misclassifying the CSF as grey matter (see the figure below).

![freesurfer_mask.jpg](freesurfer_mask.jpg)

#### qcache

We add the `-qcache` option to the `recon-all` command to generate additional surface-based measures.

#### QC

We use [fsqc](https://github.com/Deep-MI/fsqc) by Deep-MI lab for Freesurfer QC.

#### Subfield Segmentation

The subfield segmentation part includes:

- hippocampus and amygdala
- thalamus
- brainstem
- hypothalamus

#### CSV Outputs

Although Freesurfer provides `aparcstats2table` and `asegstats2table` commands to generate CSV files, we implement our own CSV generation function to have more control over the output format. All `.stats` files are parsed to generate CSV files (also when subregions stats files are available) for cortical and subcortical measures except for `*h.curv.stats`.

### Freesurfer: recon-all-clinical.sh

Some extra preprocessing steps were implemented to achieve output similar to `recon-all`, such as cortical morphology metrics. For detailed information on these steps, please refer to the [source code](https://github.com/LuuuXG/cvdproc/blob/main/cvdproc/pipelines/smri/freesurfer/recon_all_clinical.py).